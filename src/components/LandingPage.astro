---
import Logo from "./Logo.astro";
import Icon from "./Icon.astro";
import GlassContainer from "./GlassContainer.astro";
import GlassCard from "./GlassCard.astro";

// Landing page components
import BlobBackground from "./landing/BlobBackground.astro";
import FloatingCard from "./landing/FloatingCard.astro";
import QuoteCard from "./landing/QuoteCard.astro";
import BookCard from "./landing/BookCard.astro";
import VinylCard from "./landing/VinylCard.astro";
import LocationCard from "./landing/LocationCard.astro";
import ArticleCard from "./landing/ArticleCard.astro";
import SocialCard from "./landing/SocialCard.astro";
import SearchBar from "./landing/SearchBar.astro";
import PersonCard from "./landing/PersonCard.astro";
import PhoneMockup from "./landing/PhoneMockup.astro";
---

<div class="fixed inset-0 overflow-hidden bg-theme-bg font-body">
  <!-- Background -->
  <BlobBackground />

  <!-- Floating app elements -->
  <div class="floating-cards-container pointer-events-none absolute inset-0 max-md:z-[1]">
    <!-- Note card - Top left (visible on all screens, peek from edge on smaller) -->
    <FloatingCard class="left-[10%] top-[8%] w-[200px] max-lg:w-[180px] max-md:-left-[5%] max-md:top-[3%] max-md:w-[160px] max-sm:-left-[10%] max-sm:top-[2%] max-sm:w-[140px]" delay="0s">
      <GlassCard>
        <h3 class="mb-2.5 font-heading text-[15px] font-semibold leading-tight text-theme-fg">
          The cost of lost knowledge
        </h3>
        <p class="font-body text-xs leading-relaxed text-theme-fg-secondary">
          The US online recruiting market is massive: <span class="text-primary-500">$76.13bn</span> and growing at ~3% CAGR. It's a small loss that adds up quickly.
        </p>
      </GlassCard>
    </FloatingCard>

    <!-- Quote card - Top right (visible on all screens, peek from edge on smaller) -->
    <FloatingCard class="right-[18%] top-[6%] w-[300px] max-lg:right-[12%] max-lg:w-[260px] max-md:-right-[5%] max-md:top-[2%] max-md:w-[220px] max-sm:-right-[12%] max-sm:w-[200px]" delay="-1.5s">
      <GlassContainer>
        <QuoteCard day="MON" date="10" title="Thought of the day" quote="Nature does not hurry; yet everything is accomplished." />
      </GlassContainer>
    </FloatingCard>

    <!-- Book card - Left side (hidden at 1150px and below - too close to content) -->
    <FloatingCard class="left-[23%] top-[38%] w-[140px] max-[1150px]:hidden" delay="-3s">
      <BookCard title="Meditations" author="Marcus Aurelius" />
    </FloatingCard>

    <!-- Location card - Right side (only visible on large desktop) -->
    <FloatingCard class="bottom-[43%] right-[19%] w-[180px] max-[1150px]:hidden" delay="-2s">
      <LocationCard name="Eiffel Tower" address="Champ de Mars, Paris" />
    </FloatingCard>

    <!-- Article card - Bottom left (visible on all screens, peek from edge on smaller) -->
    <FloatingCard class="bottom-[12%] left-[14%] w-[190px] max-lg:left-[3%] max-lg:w-[170px] max-md:-left-[8%] max-md:bottom-[28%] max-md:w-[160px] max-sm:-left-[12%] max-sm:bottom-[32%]" delay="-4s">
      <ArticleCard source="The New Yorker" title="Should You Just Give Up?" />
    </FloatingCard>

    <!-- Social card - Bottom right (hidden at 1150px and below - too close to content) -->
    <FloatingCard class="bottom-[11%] right-[28%] w-[170px] max-[1150px]:hidden" delay="-1s">
      <SocialCard
        number="10"
        lines={["*logo tips*", "from a", "*type designer*"]}
        caption="10 Logo Design Tips from a Type Designer"
      />
    </FloatingCard>

    <!-- Vinyl/Music card - Right side (moves to location card spot on smaller screens) -->
    <FloatingCard class="right-[5%] top-[52%] w-[180px] max-[1150px]:right-[12%] max-[1150px]:top-[38%] max-lg:right-[3%] max-lg:top-[42%] max-lg:w-[160px] max-md:-right-[8%] max-md:top-[38%] max-md:w-[150px] max-sm:-right-[15%] max-sm:top-[35%]" delay="-2.5s">
      <VinylCard />
    </FloatingCard>

    <!-- Search bar (hidden on large and below) -->
    <FloatingCard class="right-[10%] top-[24%] max-lg:hidden" delay="-3.5s">
      <SearchBar placeholder="Search your thoughts..." />
    </FloatingCard>

    <!-- Space tag - subtle accent on mobile -->
    <FloatingCard class="bottom-[10%] left-[10%] max-md:bottom-[32%] max-md:left-[3%] max-sm:bottom-[38%]" delay="-4.5s">
      <div class="inline-flex items-center rounded-full border border-primary-100 bg-primary-50 px-3.5 py-2 font-heading text-[13px] font-medium text-primary-600">
        <Icon name="folderOpen" size={14} class="mr-1.5" />
        Research
      </div>
    </FloatingCard>

    <!-- Connection count (hidden at 1150px and below - clutters center) -->
    <FloatingCard class="left-[26%] top-[36%] max-[1150px]:hidden" delay="-5s">
      <div class="rounded-xl border border-theme-glass-border bg-theme-glass-bg px-3.5 py-2.5 backdrop-blur-[20px]">
        <div class="flex items-center gap-2 font-body text-[13px] text-theme-fg-secondary">
          <Icon name="graph" size={16} class="text-primary-500" />
          <span>12 connections</span>
        </div>
      </div>
    </FloatingCard>

    <!-- Person card (hidden at 1150px and below - overlaps with note card) -->
    <FloatingCard class="left-[20%] top-[18%] max-[1150px]:hidden" delay="-1.2s">
      <PersonCard name="Sarah Chen" role="Designer" />
    </FloatingCard>
  </div>

  <!-- Main content -->
  <div class="content-wrapper relative z-10 flex h-full flex-col items-center justify-center px-6">
    <!-- Logo -->
    <div class="mb-6 text-theme-fg">
      <Logo width={90} />
    </div>

    <!-- Headline -->
    <h1 class="headline mb-3 text-center font-display font-semibold tracking-tight text-theme-fg">
      <span class="block">Where ideas</span>
      <span class="highlight-word relative inline-block text-primary-600">come alive</span>
    </h1>

    <!-- Subheadline -->
    <p class="mb-8 max-w-md text-center text-[17px] leading-relaxed text-theme-fg-secondary">
      A new way to capture thoughts, connect ideas, and create something meaningful.
    </p>

    <!-- Email signup -->
    <GlassContainer class="w-full max-w-[460px]">
      <form
        id="waitlist-form"
        action="https://api.web3forms.com/submit"
        method="POST"
        class="flex items-center gap-1.5"
      >
        <div class="flex-1">
          <input
            type="email"
            id="email-input"
            name="email"
            required
            placeholder="Join the waitlist"
            aria-label="Email address"
            class="w-full rounded-xl border border-theme-border bg-theme-card-bg px-4 py-3 font-body text-[15px] text-theme-fg placeholder:text-theme-fg-tertiary focus:border-primary-400 focus:outline-none focus:ring-[3px] focus:ring-primary-500/10 disabled:opacity-50"
          />
        </div>
        <button
          type="submit"
          id="submit-btn"
          aria-label="Submit"
          class="flex size-[46px] shrink-0 items-center justify-center rounded-xl bg-primary-500 text-white transition-all duration-200 hover:bg-primary-600 active:scale-[0.98] disabled:opacity-70"
        >
          <span class="btn-icon">
            <Icon name="arrowRight" size={18} />
          </span>
          <span class="btn-spinner hidden animate-spin">
            <Icon name="loader" size={18} />
          </span>
        </button>
      </form>
      <!-- Success message (hidden by default, shown after successful submission) -->
      <div id="success-message" class="hidden items-center justify-center gap-2 py-3.5 text-center font-body text-[15px] text-green-600 opacity-0 transition-opacity duration-300">
        <Icon name="checkCircle" size={20} weight="fill" />
        <span>You're on the list!</span>
      </div>
    </GlassContainer>

    <!-- TestFlight note -->
    <p class="mt-3 max-w-[420px] text-center text-xs leading-relaxed text-theme-fg-tertiary">
      Please sign up with the email associated with your iCloud account, which you'll use for TestFlight.
    </p>
  </div>

  <!-- Phone mockup -->
  <PhoneMockup />
</div>

<style>
  /* Headline sizing */
  .headline {
    font-size: clamp(40px, 8vw, 64px);
    line-height: 1.1;
    letter-spacing: -0.03em;
  }

  /* Highlight underline effect */
  .highlight-word::after {
    content: "";
    position: absolute;
    bottom: 2px;
    left: -4px;
    right: -4px;
    height: 0.35em;
    background: var(--color-primary-200);
    border-radius: 4px;
    z-index: -1;
    transform: rotate(-1deg);
  }

  /* Content padding for phone mockup */
  .content-wrapper {
    padding-bottom: 320px;
  }

  @media (max-width: 768px) {
    .content-wrapper {
      padding-bottom: 220px;
    }
  }

  @media (max-width: 480px) {
    .content-wrapper {
      padding-bottom: 200px;
    }
  }

  @media (max-height: 800px) {
    .content-wrapper {
      padding-bottom: 260px;
    }
  }

  @media (max-height: 700px) {
    .content-wrapper {
      padding-bottom: 200px;
    }
  }

  @media (max-height: 600px) {
    .content-wrapper {
      padding-bottom: 150px;
    }
  }

  @media (max-height: 500px) {
    .content-wrapper {
      padding-bottom: 100px;
    }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-6px); }
    80% { transform: translateX(6px); }
  }
</style>

<script>
  const form = document.getElementById("waitlist-form") as HTMLFormElement;
  const emailInput = document.getElementById("email-input") as HTMLInputElement;
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
  const btnIcon = submitBtn?.querySelector(".btn-icon") as HTMLElement;
  const btnSpinner = submitBtn?.querySelector(".btn-spinner") as HTMLElement;
  const successMessage = document.getElementById("success-message") as HTMLDivElement;

  function setLoading(loading: boolean) {
    emailInput.disabled = loading;
    submitBtn.disabled = loading;
    btnIcon?.classList.toggle("hidden", loading);
    btnSpinner?.classList.toggle("hidden", !loading);
  }

  function showSuccess() {
    // Animate out the form
    form.style.opacity = "0";
    form.style.transform = "scale(0.95)";
    form.style.transition = "opacity 200ms, transform 200ms";

    setTimeout(() => {
      form.classList.add("hidden");
      successMessage.classList.remove("hidden");
      successMessage.classList.add("flex");
      // Trigger reflow then animate in
      void successMessage.offsetWidth;
      successMessage.style.opacity = "1";
    }, 200);

    // Clear the form
    emailInput.value = "";
  }

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await fetch("https://api.web3forms.com/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify({
          access_key: "03f766f7-fe94-4b8b-b8f1-1236060697f9",
          subject: "New Syne Waitlist Signup",
          from_name: "Syne Waitlist",
          email: emailInput.value,
        }),
      });

      const data = await response.json();

      if (data.success) {
        showSuccess();
      } else {
        throw new Error(data.message || "Submission failed");
      }
    } catch (err) {
      setLoading(false);
      console.error("Form submission error:", err);
      form.style.animation = "shake 0.4s ease-in-out";
      form.addEventListener(
        "animationend",
        () => {
          form.style.animation = "";
        },
        { once: true }
      );
    }
  });
</script>
